{{ define "title" }}{{ .Title }}{{ if .Parent }} - {{ .Parent.Title }}{{ end }} | {{ .Site.Title }}{{ end }}

{{ define "main" }}
  <div class="max-w-3xl mx-auto py-8">
    <article class="space-y-8">
      {{ partial "breadcrumb.html" . }}
      
      {{ $farms := where site.RegularPages "Section" "farms" }}
      {{ $filteredFarms := slice }}
      
      {{/* Initialize city coordinates variables */}}
      {{ $cityLat := 0.0 }}
      {{ $cityLng := 0.0 }}
      
      <header class="text-left space-y-8">
        {{ $currentPath := .RelPermalink }}
        {{ $pathParts := split (trim $currentPath "/") "/" }}
        {{ $category := "" }}
        {{ $h1Text := "" }}
        
        {{ if gt (len $pathParts) 0 }}
          {{ $category = index $pathParts 0 }}
          {{ $categoryPath := printf "/%s/" $category }}
          {{ $categoryPage := site.GetPage $categoryPath }}
          {{ if $categoryPage }}
            {{ $category = $categoryPage.Title }}
          {{ else }}
            {{ $category = $category | replace "-" " " | title }}
          {{ end }}
          
          {{ if eq (len $pathParts) 1 }}
            {{ $h1Text = printf "All %s farms in Canada " $category }}
            
          {{ else if eq (len $pathParts) 2 }}
            {{ $province := index $pathParts 1 }}
            {{ $provincePath := printf "/%s/%s/" (index $pathParts 0) $province }}
            {{ $provincePage := site.GetPage $provincePath }}
            {{ if $provincePage }}
              {{ $province = $provincePage.Title }}
            {{ else }}
              {{ $province = $province | replace "-" " " | title }}
            {{ end }}
            {{ $h1Text = printf "Find a %s farm in %s" $category $province }}
            
          {{ else if eq (len $pathParts) 3 }}
            {{ $categorySlug := index $pathParts 0 }}
            {{ $province := index $pathParts 1 }}
            {{ $city := index $pathParts 2 }}
            
            {{ $h1Text = printf "Find a %s farm near %s, %s" $category $city $province }}
          {{ end }}
        {{ end }}
        
        <h1 class="text-4xl md:text-5xl font-light text-gray-900 tracking-tight capitalize">{{ $h1Text }}</h1>
        <div class="prose prose-xl prose-gray">
          {{ .Content }}
        </div>
      </header>
      
      {{ if eq (len $pathParts) 1 }}
        {{/* Category pages - show all farms in category */}}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $filteredFarms = where $farms "Params.categories" "intersect" (slice $categorySlug) }}
        
        {{ partial "regional-map.html" (dict "page" . "region" "canada" "category" $categorySlug) }}
        
      {{ else if eq (len $pathParts) 2 }}
        {{/* Province pages - show farms in province */}}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $province := index $pathParts 1 }}
        {{ $province = $province | lower }}
        {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
        {{ range $categoryFarms }}
          {{ if eq (.Params.address.province | urlize) $province }}
            {{ $filteredFarms = $filteredFarms | append . }}
          {{ end }}
        {{ end }}
        
        {{ partial "regional-map.html" (dict "page" . "region" $province "category" $categorySlug) }}
        
      {{ else if eq (len $pathParts) 3 }}
        {{/* City pages - show farms within 100km */}}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $province := index $pathParts 1 }}
        {{ $city := index $pathParts 2 }}
        
        {{/* Get city coordinates */}}
        {{ if .Params.coordinates }}
          {{ $cityLat = .Params.coordinates.latitude }}
          {{ $cityLng = .Params.coordinates.longitude }}
        {{ end }}
        
        {{/* Filter farms by distance if we have city coordinates */}}
        {{ if and (ne $cityLat 0.0) (ne $cityLng 0.0) }}
          {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
          
          {{ range $categoryFarms }}
            {{ if and .Params.coordinates .Params.address }}
              {{ $farmLat := .Params.coordinates.latitude }}
              {{ $farmLng := .Params.coordinates.longitude }}
              
              {{/* Calculate distance using Haversine formula */}}
              {{ $lat1Rad := math.Mul $cityLat 0.017453292519943295 }}
              {{ $lat2Rad := math.Mul $farmLat 0.017453292519943295 }}
              {{ $deltaLatRad := math.Mul (math.Sub $farmLat $cityLat) 0.017453292519943295 }}
              {{ $deltaLngRad := math.Mul (math.Sub $farmLng $cityLng) 0.017453292519943295 }}
              
              {{ $a := math.Add (math.Mul (math.Sin (math.Div $deltaLatRad 2)) (math.Sin (math.Div $deltaLatRad 2))) (math.Mul (math.Mul (math.Cos $lat1Rad) (math.Cos $lat2Rad)) (math.Mul (math.Sin (math.Div $deltaLngRad 2)) (math.Sin (math.Div $deltaLngRad 2)))) }}
              {{ $c := math.Mul 2 (math.Atan2 (math.Sqrt $a) (math.Sqrt (math.Sub 1 $a))) }}
              {{ $distance := math.Mul 6371 $c }}
              
              {{/* Include farms within 100km */}}
              {{ if le $distance 100 }}
                {{ $filteredFarms = $filteredFarms | append . }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        
        {{ partial "regional-map.html" (dict "page" . "region" $province "category" $categorySlug "city" $city) }}
        
      {{ end }}
      
      {{ if .Pages }}
      <section aria-labelledby="locations-heading" class="space-y-12">
        <h2 id="locations-heading" class="text-3xl font-light text-gray-800 tracking-wide">Filter by Location</h2>

        <nav aria-label="Location filters" class="flex justify-center">
          <ul itemscope itemtype="https://schema.org/ItemList"
              style="padding-left: 0;"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-w-4xl w-full">
            <meta itemprop="name" content="Locations listed on this page" />
            <meta itemprop="itemListOrder" content="https://schema.org/ItemListUnordered" />
            <meta itemprop="numberOfItems" content="{{ len .Pages }}" />

            {{ range $i, $p := .Pages }}
              <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <span itemprop="item" itemscope itemtype="https://schema.org/Place" itemid="{{ $p.Permalink }}">
                  <a itemprop="url" href="{{ $p.RelPermalink }}">
                    <span itemprop="name" class="text-center font-light group-hover:text-gray-900 tracking-wide hover:underline">
                      {{ $p.LinkTitle }}
                    </span>
                  </a>
                </span>
                <meta itemprop="position" content="{{ add $i 1 }}" />
              </li>
            {{ end }}
          </ul>
        </nav>
      </section>
      {{ end }}
      
      <section aria-labelledby="farms-heading" class="space-y-12">
        <h2 id="farms-heading" class="text-3xl font-light text-gray-800 tracking-wide">Farms</h2>

        {{ if $filteredFarms }}
          <ul itemscope itemtype="https://schema.org/ItemList"
              style="padding-left: 0;"
              class="space-y-4">
            <meta itemprop="name" content="Farms listed on this page" />
            <meta itemprop="itemListOrder" content="https://schema.org/ItemListUnordered" />
            <meta itemprop="numberOfItems" content="{{ len $filteredFarms }}" />

            {{ range $i, $farm := $filteredFarms }}
              <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a href="{{ $farm.RelPermalink }}" 
                   class="block w-full bg-white rounded-lg border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-300 ease-in-out"
                   itemprop="item"
                   itemscope itemtype="https://schema.org/LocalBusiness"
                   itemid="{{ $farm.Permalink }}#business">
                  
                  <div class="space-y-3">
                    <!-- Farm Name -->
                    <h3 class="text-xl font-semibold text-gray-900" itemprop="name">
                      {{ $farm.LinkTitle }}
                    </h3>
                    
                    <!-- Farm Categories -->
                    {{ if $farm.Params.categories }}
                      <h4 class="text-sm font-medium text-gray-600 capitalize">
                        {{ delimit (apply $farm.Params.categories "replace" "." "-" " ") ", " }} Farm in {{ .Params.address.city }}
                      </h4>
                    {{ end }}
                    
                    <!-- Full Address -->
                    {{ with $farm.Params.address }}
                      <p class="text-xs text-gray-600" itemprop="address" itemscope itemtype="https://schema.org/PostalAddress">
                        <span itemprop="streetAddress">{{ .street }}</span>{{ if .street }}, {{ end }}
                        <span itemprop="addressLocality">{{ .city }}</span>, 
                        <span itemprop="addressRegion">{{ .province }}</span>
                        {{ if .postal_code }}<span itemprop="postalCode"> {{ .postal_code }}</span>{{ end }}
                      </p>
                    {{ end }}
                    
                    <!-- Driving Time (for city pages) -->
                    {{ if eq (len $pathParts) 3 }}
                      {{ if and $farm.Params.coordinates (ne $cityLat 0.0) (ne $cityLng 0.0) }}
                        {{ $farmLat := $farm.Params.coordinates.latitude }}
                        {{ $farmLng := $farm.Params.coordinates.longitude }}
                        
                        {{/* Calculate distance using Haversine formula */}}
                        {{ $lat1Rad := math.Mul $cityLat 0.017453292519943295 }}
                        {{ $lat2Rad := math.Mul $farmLat 0.017453292519943295 }}
                        {{ $deltaLatRad := math.Mul (math.Sub $farmLat $cityLat) 0.017453292519943295 }}
                        {{ $deltaLngRad := math.Mul (math.Sub $farmLng $cityLng) 0.017453292519943295 }}
                        
                        {{ $a := math.Add (math.Mul (math.Sin (math.Div $deltaLatRad 2)) (math.Sin (math.Div $deltaLatRad 2))) (math.Mul (math.Mul (math.Cos $lat1Rad) (math.Cos $lat2Rad)) (math.Mul (math.Sin (math.Div $deltaLngRad 2)) (math.Sin (math.Div $deltaLngRad 2)))) }}
                        {{ $c := math.Mul 2 (math.Atan2 (math.Sqrt $a) (math.Sqrt (math.Sub 1 $a))) }}
                        {{ $distance := math.Mul 6371 $c }}
                        
                        {{/* Estimate driving time (assuming average 60 km/h) */}}
                        {{ $drivingTimeHours := math.Div $distance 60 }}
                        {{ $drivingTimeMinutes := math.Mul $drivingTimeHours 60 }}
                        
                        <p class="text-sm text-blue-600 font-medium">
                          <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          {{ if lt $drivingTimeMinutes 60 }}
                            {{ printf "%.0f minutes drive" $drivingTimeMinutes }}
                          {{ else }}
                            {{ $hours := math.Floor $drivingTimeHours }}
                            {{ $totalMinutes := math.Floor $drivingTimeMinutes }}
                            {{ $remainingMinutes := math.Sub $totalMinutes (math.Mul $hours 60) }}
                            {{ if eq $remainingMinutes 0 }}
                              {{ printf "%.0f hour drive" $hours }}
                            {{ else }}
                              {{ printf "%.0f hour %.0f minutes drive" $hours $remainingMinutes }}
                            {{ end }}
                          {{ end }}
                        </p>
                      {{ end }}
                    {{ end }}
                    
                    <!-- Learn More Visual Indicator -->
                    <div class="pt-2 flex items-center text-green-600 font-medium text-sm">
                      <span>Learn more</span>
                      <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </div>
                  </div>
                </a>
                
                <meta itemprop="position" content="{{ add $i 1 }}" />
              </li>
            {{ end }}
          </ul>
        {{ else }}
          <div class="text-center py-12">
            <p class="text-lg font-light text-gray-600">No farms found in this category/location.</p>
          </div>
        {{ end }}
      </section>

      {{/* Add FAQs section only for top-level category pages */}}
      {{ if eq (len $pathParts) 1 }}
        {{ $categorySlug := index $pathParts 0 }}
        {{ partial "faqs.html" (dict "categorySlug" $categorySlug) }}
      {{ end }}
    </article>
  </div>
{{ end }}