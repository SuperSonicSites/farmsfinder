{{ define "title" }}{{ .Title }}{{ if .Parent }} - {{ .Parent.Title }}{{ end }} | {{ .Site.Title }}{{ end }}

{{ define "main" }}
  <div class="max-w-3xl mx-auto py-8">
    <article class="space-y-8">
      {{ partial "breadcrumb.html" . }}
      
      {{ $farms := where site.RegularPages "Section" "farms" }}
      {{ $filteredFarms := slice }}
      
      <header class="text-left space-y-8">
        {{ $currentPath := .RelPermalink }}
        {{ $pathParts := split (trim $currentPath "/") "/" }}
        {{ $category := "" }}
        {{ $h1Text := "" }}
        
        {{ if gt (len $pathParts) 0 }}
          {{ $category = index $pathParts 0 }}
          {{ $categoryPath := printf "/%s/" $category }}
          {{ $categoryPage := site.GetPage $categoryPath }}
          {{ if $categoryPage }}
            {{ $category = $categoryPage.Title }}
          {{ else }}
            {{ $category = $category | replace "-" " " | title }}
          {{ end }}
          
          {{ if eq (len $pathParts) 1 }}
            {{ $h1Text = printf "All %s farms in Canada " $category }}
            
          {{ else if eq (len $pathParts) 2 }}
            {{ $province := index $pathParts 1 }}
            {{ $provincePath := printf "/%s/%s/" (index $pathParts 0) $province }}
            {{ $provincePage := site.GetPage $provincePath }}
            {{ if $provincePage }}
              {{ $province = $provincePage.Title }}
            {{ else }}
              {{ $province = $province | replace "-" " " | title }}
            {{ end }}
            {{ $h1Text = printf "Find a %s farm in %s" $category $province }}
            
          {{ else if eq (len $pathParts) 3 }}
            {{ $categorySlug := index $pathParts 0 }}
            {{ $province := index $pathParts 1 }}
            {{ $city := index $pathParts 2 }}
            

            
            {{ $h1Text = printf "Find a %s farm near %s, %s" $category $city $province }}
          {{ end }}
        {{ end }}
        
        <h1 class="text-4xl md:text-5xl font-light text-gray-900 tracking-tight capitalize">{{ $h1Text }}</h1>
        <div class="prose prose-xl prose-gray">
          {{ .Content }}
        </div>
      </header>
      
      {{ if eq (len $pathParts) 1 }}
        {{/* Category pages - show all farms in category */}}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $filteredFarms = where $farms "Params.categories" "intersect" (slice $categorySlug) }}
        
        {{ partial "regional-map.html" (dict "page" . "region" "canada" "category" $categorySlug) }}
        
      {{ else if eq (len $pathParts) 2 }}
        {{/* Province pages - show farms in province */}}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $province := index $pathParts 1 }}
        {{ $province = $province | lower }}
        {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
        {{ range $categoryFarms }}
          {{ if eq (.Params.address.province | urlize) $province }}
            {{ $filteredFarms = $filteredFarms | append . }}
          {{ end }}
        {{ end }}
        
        {{ partial "regional-map.html" (dict "page" . "region" $province "category" $categorySlug) }}
        
      {{ else if eq (len $pathParts) 3 }}
        {{/* City pages - show farms within 80km */}}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $province := index $pathParts 1 }}
        {{ $city := index $pathParts 2 }}
        
        {{/* Get city coordinates */}}
        {{ $cityLat := 0.0 }}
        {{ $cityLng := 0.0 }}
        
        
        
        {{ if .Params.coordinates }}
          {{ $cityLat = .Params.coordinates.latitude }}
          {{ $cityLng = .Params.coordinates.longitude }}
        {{ end }}
        
        
        
        {{/* Filter farms by distance if we have city coordinates */}}
        {{ if and (ne $cityLat 0.0) (ne $cityLng 0.0) }}
          {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
          
         
          
          {{ range $categoryFarms }}
            
            
            {{ if and .Params.coordinates .Params.address }}
              {{ $farmLat := .Params.coordinates.latitude }}
              {{ $farmLng := .Params.coordinates.longitude }}
              
              {{/* Calculate distance using Haversine formula */}}
              {{ $lat1Rad := math.Mul $cityLat 0.017453292519943295 }}
              {{ $lat2Rad := math.Mul $farmLat 0.017453292519943295 }}
              {{ $deltaLatRad := math.Mul (math.Sub $farmLat $cityLat) 0.017453292519943295 }}
              {{ $deltaLngRad := math.Mul (math.Sub $farmLng $cityLng) 0.017453292519943295 }}
              
              {{ $a := math.Add (math.Mul (math.Sin (math.Div $deltaLatRad 2)) (math.Sin (math.Div $deltaLatRad 2))) (math.Mul (math.Mul (math.Cos $lat1Rad) (math.Cos $lat2Rad)) (math.Mul (math.Sin (math.Div $deltaLngRad 2)) (math.Sin (math.Div $deltaLngRad 2)))) }}
              {{ $c := math.Mul 2 (math.Atan2 (math.Sqrt $a) (math.Sqrt (math.Sub 1 $a))) }}
              {{ $distance := math.Mul 6371 $c }}
              
              
              
              {{/* Include farms within 80km */}}
              {{ if le $distance 80 }}
                {{ $filteredFarms = $filteredFarms | append . }}
                
              {{ else }}
                
              {{ end }}
            {{ else }}
              
            {{ end }}
          {{ end }}
          
          
        {{ else }}

        {{ end }}
        
        {{ partial "regional-map.html" (dict "page" . "region" $province "category" $categorySlug "city" $city) }}
        
      {{ end }}
      
      {{ if .Pages }}
      <section aria-labelledby="locations-heading" class="space-y-12">
        <h2 id="locations-heading" class="text-3xl font-light text-gray-800 tracking-wide">Filter by Location</h2>

        <nav aria-label="Location filters" class="flex justify-center">
          <ul itemscope itemtype="https://schema.org/ItemList"
              style="padding-left: 0;"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-w-4xl w-full">
            <meta itemprop="name" content="Locations listed on this page" />
            <meta itemprop="itemListOrder" content="https://schema.org/ItemListUnordered" />
            <meta itemprop="numberOfItems" content="{{ len .Pages }}" />

            {{ range $i, $p := .Pages }}
              <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <span itemprop="item" itemscope itemtype="https://schema.org/Place" itemid="{{ $p.Permalink }}">
                  <a itemprop="url" href="{{ $p.RelPermalink }}">
                    <span itemprop="name" class="text-center font-light group-hover:text-gray-900 tracking-wide hover:underline">
                      {{ $p.LinkTitle }}
                    </span>
                  </a>
                </span>
                <meta itemprop="position" content="{{ add $i 1 }}" />
              </li>
            {{ end }}
          </ul>
        </nav>
      </section>
      {{ end }}
      
      <section aria-labelledby="farms-heading" class="space-y-12">
        <h2 id="farms-heading" class="text-3xl font-light text-gray-800 tracking-wide">Farms</h2>

        {{ if $filteredFarms }}
          <div class="flex">
            <ul itemscope itemtype="https://schema.org/ItemList"
                style="padding-left: 0;"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 max-w-4xl w-full">
              <meta itemprop="name" content="Farms listed on this page" />
              <meta itemprop="itemListOrder" content="https://schema.org/ItemListUnordered" />
              <meta itemprop="numberOfItems" content="{{ len $filteredFarms }}" />

              {{ range $i, $farm := $filteredFarms }}
                <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                  <span itemprop="item"
                        itemscope itemtype="https://schema.org/LocalBusiness"
                        itemid="{{ $farm.Permalink }}#business">

                    <a itemprop="url"
                       href="{{ $farm.RelPermalink }}"
                       class="hover:text-gray-700 transition-colors">
                      <span itemprop="name">{{ $farm.LinkTitle }}</span>
                    </a>

                    <p class="text-gray-600 font-light">
                      {{ with $farm.Params.address }}
                        <span itemprop="address" itemscope itemtype="https://schema.org/PostalAddress">
                          <span itemprop="addressLocality">{{ .city }}</span>, <span itemprop="addressRegion">{{ .province }}</span>
                        </span>
                      {{ end }}
                    </p>
                  </span>

                  <meta itemprop="position" content="{{ add $i 1 }}" />
                </li>
              {{ end }}
            </ul>
          </div>
        {{ else }}
          <div class="text-center py-12">
            <p class="text-lg font-light text-gray-600">No farms found in this category/location.</p>
          </div>
        {{ end }}
      </section>

      {{/* Add FAQs section only for top-level category pages */}}
      {{ if eq (len $pathParts) 1 }}
        {{ $categorySlug := index $pathParts 0 }}
        {{ partial "faqs.html" (dict "categorySlug" $categorySlug) }}
      {{ end }}
    </article>
  </div>
{{ end }}