{{ define "title" }}{{ .Title }}{{ if .Parent }} - {{ .Parent.Title }}{{ end }} | {{ .Site.Title }}{{ end }}

{{ define "main" }}
  <article>
    {{ partial "breadcrumb.html" . }}
    
    <header>
      {{ $currentPath := .RelPermalink }}
      {{ $pathParts := split (trim $currentPath "/") "/" }}
      {{ $category := "" }}
      {{ $h1Text := "" }}
      
      {{ if gt (len $pathParts) 0 }}
        {{ $category = index $pathParts 0 }}
        {{ $categoryPath := printf "/%s/" $category }}
        {{ $categoryPage := site.GetPage $categoryPath }}
        {{ if $categoryPage }}
          {{ $category = $categoryPage.Title }}
        {{ else }}
          {{ $category = $category | replace "-" " " | title }}
        {{ end }}
        
        {{ if eq (len $pathParts) 1 }}
          {{ $h1Text = printf "Find a %s farm near you" $category }}
        {{ else if eq (len $pathParts) 2 }}
          {{ $province := index $pathParts 1 }}
          {{ $provincePath := printf "/%s/%s/" (index $pathParts 0) $province }}
          {{ $provincePage := site.GetPage $provincePath }}
          {{ if $provincePage }}
            {{ $province = $provincePage.Title }}
          {{ else }}
            {{ $province = $province | replace "-" " " | title }}
          {{ end }}
          {{ $h1Text = printf "Find a %s farm in %s" $category $province }}
        {{ else if eq (len $pathParts) 3 }}
          {{ $province := index $pathParts 1 }}
          {{ $provincePath := printf "/%s/%s/" (index $pathParts 0) $province }}
          {{ $provincePage := site.GetPage $provincePath }}
          {{ if $provincePage }}
            {{ $province = $provincePage.Title }}
          {{ else }}
            {{ $province = $province | replace "-" " " | title }}
          {{ end }}
          {{ $city := index $pathParts 2 }}
          {{ $cityPath := printf "/%s/%s/%s/" (index $pathParts 0) (index $pathParts 1) $city }}
          {{ $cityPage := site.GetPage $cityPath }}
          {{ if $cityPage }}
            {{ $city = $cityPage.Title }}
          {{ else }}
            {{ $city = $city | replace "-" " " | title }}
          {{ end }}
          {{ $h1Text = printf "Find a %s farm in %s, %s" $category $city $province }}
        {{ end }}
      {{ end }}
      
      <h1 style="text-transform: capitalize;">{{ $h1Text }}</h1>
      {{ .Content }}
    </header>
    
    {{ $farms := where site.RegularPages "Section" "farms" }}
    {{ $filteredFarms := slice }}
    
    {{ if eq (len $pathParts) 1 }}
      {{ $categorySlug := index $pathParts 0 }}
      {{ $filteredFarms = where $farms "Params.categories" "intersect" (slice $categorySlug) }}
    {{ else if eq (len $pathParts) 2 }}
      {{ $categorySlug := index $pathParts 0 }}
      {{ $province := index $pathParts 1 }}
      {{ $province = $province | lower }}
      {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
      {{ range $categoryFarms }}
        {{ if eq (.Params.province | lower) $province }}
          {{ $filteredFarms = $filteredFarms | append . }}
        {{ end }}
      {{ end }}
    {{ else if eq (len $pathParts) 3 }}
      {{ $categorySlug := index $pathParts 0 }}
      {{ $province := index $pathParts 1 }}
      {{ $province = $province | lower }}
      {{ $city := index $pathParts 2 }}
      {{ $city = $city | lower }}
      {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
      {{ range $categoryFarms }}
        {{ if and (eq (.Params.province | lower) $province) (eq (.Params.city | lower) $city) }}
          {{ $filteredFarms = $filteredFarms | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{ if .Pages }}
      <section aria-labelledby="locations-heading">
        <h2 id="locations-heading">Filter by Location</h2>
        <nav aria-label="Location filters">
          <ul>
          {{ range .Pages }}
            <li><a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a></li>
          {{ end }}
          </ul>
        </nav>
      </section>
    {{ end }}
    
    <section aria-labelledby="farms-heading">
      <h2 id="farms-heading">Farms</h2>
      {{ if $filteredFarms }}
        <ul>
        {{ range $filteredFarms }}
          <li>
            <article>
              <p><a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a> - {{ .Params.city }}, {{ .Params.province }}</p>
              {{ with .Summary }}<p>{{ . }}</p>{{ end }}
            </article>
          </li>
        {{ end }}
        </ul>
      {{ else }}
        <p>No farms found in this category/location.</p>
      {{ end }}
    </section>
  </article>
{{ end }}
