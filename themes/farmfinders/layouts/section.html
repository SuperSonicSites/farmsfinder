{{ define "title" }}{{ .Title }}{{ if .Parent }} - {{ .Parent.Title }}{{ end }} | {{ .Site.Title }}{{ end }}

{{ define "main" }}
  <div class="max-w-3xl mx-auto py-16">
    <article class="space-y-16">
      {{ partial "breadcrumb.html" . }}
      
      <header class="text-left space-y-8">
        {{ $currentPath := .RelPermalink }}
        {{ $pathParts := split (trim $currentPath "/") "/" }}
        {{ $category := "" }}
        {{ $h1Text := "" }}
        
        {{ if gt (len $pathParts) 0 }}
          {{ $category = index $pathParts 0 }}
          {{ $categoryPath := printf "/%s/" $category }}
          {{ $categoryPage := site.GetPage $categoryPath }}
          {{ if $categoryPage }}
            {{ $category = $categoryPage.Title }}
          {{ else }}
            {{ $category = $category | replace "-" " " | title }}
          {{ end }}
          
          {{ if eq (len $pathParts) 1 }}
            {{ $h1Text = printf "Find a %s farm near you" $category }}
          {{ else if eq (len $pathParts) 2 }}
            {{ $province := index $pathParts 1 }}
            {{ $provincePath := printf "/%s/%s/" (index $pathParts 0) $province }}
            {{ $provincePage := site.GetPage $provincePath }}
            {{ if $provincePage }}
              {{ $province = $provincePage.Title }}
            {{ else }}
              {{ $province = $province | replace "-" " " | title }}
            {{ end }}
            {{ $h1Text = printf "Find a %s farm in %s" $category $province }}
          {{ else if eq (len $pathParts) 3 }}
            {{ $province := index $pathParts 1 }}
            {{ $provincePath := printf "/%s/%s/" (index $pathParts 0) $province }}
            {{ $provincePage := site.GetPage $provincePath }}
            {{ if $provincePage }}
              {{ $province = $provincePage.Title }}
            {{ else }}
              {{ $province = $province | replace "-" " " | title }}
            {{ end }}
            {{ $city := index $pathParts 2 }}
            {{ $cityPath := printf "/%s/%s/%s/" (index $pathParts 0) (index $pathParts 1) $city }}
            {{ $cityPage := site.GetPage $cityPath }}
            {{ if $cityPage }}
              {{ $city = $cityPage.Title }}
            {{ else }}
              {{ $city = $city | replace "-" " " | title }}
            {{ end }}
            {{ $h1Text = printf "Find a %s farm near %s, %s" $category $city $province }}
          {{ end }}
        {{ end }}
        
        <h1 class="text-4xl md:text-6xl font-light text-gray-900 tracking-tight capitalize">{{ $h1Text }}</h1>
        <div class="prose prose-xl prose-gray">
          {{ .Content }}
        </div>
      </header>
      
      {{ $farms := where site.RegularPages "Section" "farms" }}
      {{ $filteredFarms := slice }}
      
      {{ if eq (len $pathParts) 1 }}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $filteredFarms = where $farms "Params.categories" "intersect" (slice $categorySlug) }}
      {{ else if eq (len $pathParts) 2 }}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $province := index $pathParts 1 }}
        {{ $province = $province | lower }}
        {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
        {{ range $categoryFarms }}
          {{ if eq (.Params.address.province | lower) $province }}
            {{ $filteredFarms = $filteredFarms | append . }}
          {{ end }}
        {{ end }}
        
        <!-- Regional Map for Provincial Pages -->
        {{ partial "regional-map.html" (dict "page" . "region" $province "category" $categorySlug) }}
        
      {{ else if eq (len $pathParts) 3 }}
        {{ $categorySlug := index $pathParts 0 }}
        {{ $province := index $pathParts 1 }}
        {{ $province = $province | lower }}
        {{ $city := index $pathParts 2 }}
        {{ $city = $city | lower }}
        
        {{- /* Get city center coordinates - same logic as regional-map.html */ -}}
        {{- $cityLat := 0.0 }}
        {{- $cityLng := 0.0 }}
        {{- /* First try current page coordinates */ -}}
        {{- if and .Params.coordinates .Params.location_type }}
          {{- $cityLat = .Params.coordinates.latitude }}
          {{- $cityLng = .Params.coordinates.longitude }}
        {{- else }}
          {{- /* Fallback: get coordinates from any farm in that city */ -}}
          {{- range site.Pages }}
            {{- if and (eq .Section "farms") .Params.coordinates .Params.address }}
              {{- if eq (lower .Params.address.city) $city }}
                {{- $cityLat = .Params.coordinates.latitude }}
                {{- $cityLng = .Params.coordinates.longitude }}
                {{- break }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
        
        {{- /* Filter farms using same logic as regional-map.html */ -}}
        {{ $categoryFarms := where $farms "Params.categories" "intersect" (slice $categorySlug) }}
        {{ range $categoryFarms }}
          {{- if and .Params.coordinates .Params.address }}
            {{- $farmRegion := lower .Params.address.province }}
            {{- $farmCity := lower .Params.address.city }}
            {{- $farmLat := .Params.coordinates.latitude }}
            {{- $farmLng := .Params.coordinates.longitude }}
            
            {{- $matchesCategory := in .Params.categories $categorySlug }}
            {{- $matchesRegion := eq $farmRegion $province }}
            
            {{- /* Check for exact city match first */ -}}
            {{- $exactCityMatch := eq $farmCity $city | or (eq (replace $farmCity " " "-") $city) }}
            
            {{- /* Calculate distance for nearby farms */ -}}
            {{- $matchesCity := $exactCityMatch }}
            {{- if and (not $exactCityMatch) (gt $cityLat 0) (gt $cityLng 0) }}
              {{- $lat1Rad := math.Mul $cityLat 0.017453292519943295 }}
              {{- $lat2Rad := math.Mul $farmLat 0.017453292519943295 }}
              {{- $deltaLatRad := math.Mul (math.Sub $farmLat $cityLat) 0.017453292519943295 }}
              {{- $deltaLngRad := math.Mul (math.Sub $farmLng $cityLng) 0.017453292519943295 }}
              {{- $a := math.Add (math.Mul (math.Sin (math.Div $deltaLatRad 2)) (math.Sin (math.Div $deltaLatRad 2))) (math.Mul (math.Mul (math.Cos $lat1Rad) (math.Cos $lat2Rad)) (math.Mul (math.Sin (math.Div $deltaLngRad 2)) (math.Sin (math.Div $deltaLngRad 2)))) }}
              {{- $c := math.Mul 2 (math.Atan2 (math.Sqrt $a) (math.Sqrt (math.Sub 1 $a))) }}
              {{- $distance := math.Mul 6371 $c }}
              {{- /* Include farms within 80km (approximately 1 hour drive) */ -}}
              {{- $matchesCity = le $distance 80 }}
            {{- end }}
            
            {{- if and $matchesCategory $matchesRegion $matchesCity }}
              {{ $filteredFarms = $filteredFarms | append . }}
            {{- end }}
          {{- end }}
        {{ end }}
        
        <!-- Regional Map for City Pages -->
        {{ partial "regional-map.html" (dict "page" . "region" $province "category" $categorySlug "city" $city) }}
        
      {{ end }}
      
      {{ if .Pages }}
        <section aria-labelledby="locations-heading" class="space-y-12">
          <h2 id="locations-heading" class="text-3xl font-light text-gray-800 tracking-wide">Filter by Location</h2>
          <nav aria-label="Location filters" class="flex justify-center">
            <ul style="padding-left: 0;" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-w-4xl w-full">
              {{ range .Pages }}
                <li>
                  <a href="{{ .RelPermalink }}">
                    <span class="text-center font-light group-hover:text-gray-900 tracking-wide hover:underline">
                      {{ .LinkTitle }}
                    </span>
                  </a>
                </li>
              {{ end }}
            </ul>
          </nav>
        </section>
      {{ end }}
      
      <section aria-labelledby="farms-heading" class="space-y-12">
        <h2 id="farms-heading" class="text-3xl font-light text-gray-800 tracking-wide">Farms</h2>
        {{ if $filteredFarms }}
          <div class="flex">
            <ul style="padding-left: 0;" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 max-w-4xl w-full">
              {{ range $filteredFarms }}
                <li>
                      <a href="{{ .RelPermalink }}" class="hover:text-gray-700 transition-colors">{{ .LinkTitle }}</a>
                    
                    <p class="text-gray-600 font-light">{{ .Params.address.city }}, {{ .Params.address.province }}</p>
                  
                </li>
              {{ end }}
            </ul>
          </div>
        {{ else }}
          <div class="text-center py-12">
            <p class="text-lg font-light text-gray-600">No farms found in this category/location.</p>
          </div>
        {{ end }}
      </section>
    </article>
  </div>
{{ end }}
