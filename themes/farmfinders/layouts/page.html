{{ define "main" }}
  <div div class="max-w-3xl mx-auto py-8">
    {{ if eq .Section "farms" }}
      {{ partial "breadcrumb.html" . }}
    {{ end }}

    <article class="">
      {{ if eq .Section "farms" }}
        <!-- Title -->
        <header class="text-left space-y-6">
          <h1 class="text-4xl md:text-5xl font-light text-gray-900 tracking-tight">{{ .Title }}</h1>
          <!-- Category -->
           
          {{ if .Params.categories }}
          <div class="text-gray-600">
            {{ range $i, $category := .Params.categories }}
              {{ if gt $i 0 }}, {{ end }}
              {{ $categoryPath := printf "/%s/" ($category | urlize) }}
              {{ $categoryPage := site.GetPage $categoryPath }}
              <a href="{{ $categoryPath }}" class="text-blue-600 hover:text-blue-800 font-light">
                {{ if $categoryPage }}{{ $categoryPage.Title }}{{ else }}{{ $category | title }}{{ end }}
              </a>
            {{ end }}
            
            {{ if and .Params.address .Params.address.city .Params.coordinates }}
              Farm 
              {{ $farmLat := .Params.coordinates.latitude }}
              {{ $farmLng := .Params.coordinates.longitude }}
              {{ $province := .Params.address.province | lower | replaceRE " +" "-" }}
              {{ $actualCity := .Params.address.city }}
              {{ $categorySlug := index .Params.categories 0 }}
              
              {{/* Find the nearest city with an actual page */}}
              {{ $nearestCity := "" }}
              {{ $nearestCityPath := "" }}
              {{ $nearestDistance := 1000.0 }}
              {{ $exactMatch := false }}
              
              {{/* First check if there's an exact match for the farm's city */}}
              {{ $exactCitySlug := $actualCity | lower | replaceRE "[^a-zA-Z0-9]+" "-" }}
              {{ $exactCityPath := printf "/%s/%s/%s/" $categorySlug $province $exactCitySlug }}
              {{ $exactCityPage := site.GetPage $exactCityPath }}
              
              {{ if $exactCityPage }}
                {{/* Exact city match found */}}
                {{ $nearestCity = $actualCity }}
                {{ $nearestCityPath = $exactCityPath }}
                {{ $exactMatch = true }}
              {{ else }}
                {{/* No exact match, find nearest city with a page */}}
                {{ $categoryProvincePath := printf "/%s/%s/" $categorySlug $province }}
                {{ $categoryProvincePage := site.GetPage $categoryProvincePath }}
                
                {{ if $categoryProvincePage }}
                  {{ range $categoryProvincePage.Pages }}
                    {{ if and .Params.coordinates .Params.location_type }}
                      {{/* This is a city page with coordinates */}}
                      {{ $cityLat := .Params.coordinates.latitude }}
                      {{ $cityLng := .Params.coordinates.longitude }}
                      
                      {{/* Calculate distance using Haversine formula */}}
                      {{ $lat1Rad := math.Mul $farmLat 0.017453292519943295 }}
                      {{ $lat2Rad := math.Mul $cityLat 0.017453292519943295 }}
                      {{ $deltaLatRad := math.Mul (math.Sub $cityLat $farmLat) 0.017453292519943295 }}
                      {{ $deltaLngRad := math.Mul (math.Sub $cityLng $farmLng) 0.017453292519943295 }}
                      
                      {{ $a := math.Add (math.Mul (math.Sin (math.Div $deltaLatRad 2)) (math.Sin (math.Div $deltaLatRad 2))) (math.Mul (math.Mul (math.Cos $lat1Rad) (math.Cos $lat2Rad)) (math.Mul (math.Sin (math.Div $deltaLngRad 2)) (math.Sin (math.Div $deltaLngRad 2)))) }}
                      {{ $c := math.Mul 2 (math.Atan2 (math.Sqrt $a) (math.Sqrt (math.Sub 1 $a))) }}
                      {{ $distance := math.Mul 6371 $c }}
                      
                      {{ if lt $distance $nearestDistance }}
                        {{ $nearestDistance = $distance }}
                        {{ $nearestCity = .Title }}
                        {{ $nearestCityPath = .RelPermalink }}
                      {{ end }}
                    {{ end }}
                  {{ end }}
                {{ end }}
              {{ end }}
              
              {{/* Display the result */}}
              {{ if $nearestCityPath }}
                {{ if $exactMatch }}
                  in 
                  <a href="{{ $nearestCityPath }}" class="text-blue-600 hover:text-blue-800 font-light">{{ $nearestCity }}</a>
                {{ else if lt $nearestDistance 80 }}
                  near 
                  <a href="{{ $nearestCityPath }}" class="text-blue-600 hover:text-blue-800 font-light">{{ $nearestCity }}</a>
                  {{ if lt $nearestDistance 20 }}
                    <span class="text-sm text-gray-500">({{ printf "%.0f" $nearestDistance }}km)</span>
                  {{ end }}
                {{ else }}
                  in {{ $actualCity }}
                {{ end }}
              {{ else }}
                {{/* No city pages found, just show the actual city */}}
                in {{ $actualCity }}
              {{ end }}
            {{ else if and .Params.address .Params.address.city }}
              {{/* Farm has no coordinates, fall back to original behavior */}}
              Farm in 
              {{ $province := .Params.address.province | lower | replaceRE " +" "-" }}
              {{ $city := .Params.address.city | lower | replaceRE "[^a-zA-Z0-9]+" "-" }}
              {{ $categorySlug := index .Params.categories 0 }}
              {{ $cityPath := printf "/%s/%s/%s/" $categorySlug $province $city }}
              {{ $cityPage := site.GetPage $cityPath }}
              {{ if $cityPage }}
                <a href="{{ $cityPath }}" class="text-blue-600 hover:text-blue-800 font-light">{{ .Params.address.city }}</a>
              {{ else }}
                {{ .Params.address.city }}
              {{ end }}
            {{ end }}
            
            <!-- Established -->
            {{ if .Params.established }}
              {{ if and .Params.address .Params.address.city }} ‚Ä¢ {{ end }}Established in {{ .Params.established }}
            {{ end }}
          </div>
          {{ end }}
        </header>
          <section class="border-t border-gray-200 py-4">
            <!-- Google Maps Embed -->
            {{ if .Params.place_id }}
              <div class="">
                
                <div class="w-full rounded-lg overflow-hidden shadow-lg">
                  <iframe
                    width="100%"
                    height="500px"
                    frameborder="0"
                    style="border:0"
                    src="https://www.google.com/maps/embed/v1/place?key={{ .Site.Params.googleMapsApiKey }}&q=place_id:{{ .Params.place_id }}"
                    allowfullscreen>
                  </iframe>
                </div>
              </div>
            {{ end }}
          
          </section>
          
          <!-- Website URL-->
        {{ if .Params.website }}
          <section class="grid grid grid-cols-2 gap-2">
            <div class="col-span-1">
            <a href="{{ .Params.website }}" target="_blank" rel="noopener noreferrer" class="text-xl block bg-white border border-gray-200 rounded-xl p-2 text-center hover:shadow-lg hover:border-gray-300 transition-all duration-300 group shadow-sm">üîó Visit Website</span></a><br>
          </div>
          <div class="col-span-1">
            <a href="{{ .Params.location_link }}" target="_blank" rel="noopener noreferrer" class="text-xl block bg-white border border-gray-200 rounded-xl p-2 text-center hover:shadow-lg hover:border-gray-300 transition-all duration-300 group shadow-sm">üìç Get directions</span></a>
          </div>
          </section>
        {{ end }}
<!-- Hours -->
 <!-- Seasonal Dates -->
 <section class="border-t border-gray-200 py-4">
  <h2 class="text-2xl font-light text-gray-800 mb-2">Season</h2>
  <div class="text-gray-600">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-b border-gray-200 bg-blue-50">
          <th class="text-left py-3 px-2 font-medium text-gray-700">Opening Date</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Closing Date</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="py-3 px-2 text-gray-600">{{ if .Params.opening_date }}{{ .Params.opening_date }}{{ else }}Coming Soon{{ end }}</td>
          <td class="py-3 px-2 text-gray-600">{{ if .Params.closing_date }}{{ .Params.closing_date }}{{ else }}Coming Soon{{ end }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
{{ if or .Params.hours.friday .Params.hours.saturday .Params.hours.sunday .Params.hours.monday .Params.hours.tuesday .Params.hours.wednesday .Params.hours.thursday }}
<section class="space-y-2 border-t border-gray-200 py-4">
  <h2 class="text-2xl font-light text-gray-800">Hours</h2>
  
  <!-- Desktop Table (horizontal) -->
  <div class="hidden md:block">
    <table class="w-full border-collapse">
      <thead>
        <tr class="border-b border-gray-200 bg-blue-50">
          <th class="text-left py-3 px-2 font-medium text-gray-700">Monday</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Tuesday</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Wednesday</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Thursday</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Friday</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Saturday</th>
          <th class="text-left py-3 px-2 font-medium text-gray-700">Sunday</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.monday }}</td>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.tuesday }}</td>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.wednesday }}</td>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.thursday }}</td>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.friday }}</td>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.saturday }}</td>
          <td class="py-3 px-2 text-gray-600">{{ .Params.hours.sunday }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile Table (vertical) -->
  <div class="md:hidden">
    <div class="space-y-2">
      
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Monday</span>
          <span class="text-gray-600">{{ .Params.hours.monday }}</span>
        </div>
      
      
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Tuesday</span>
          <span class="text-gray-600">{{ .Params.hours.tuesday }}</span>
        </div>
     
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Wednesday</span>
          <span class="text-gray-600">{{ .Params.hours.wednesday }}</span>
        </div>
      
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Thursday</span>
          <span class="text-gray-600">{{ .Params.hours.thursday }}</span>
        </div>
      
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Friday</span>
          <span class="text-gray-600">{{ .Params.hours.friday }}</span>
        </div>
     
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Saturday</span>
          <span class="text-gray-600">{{ .Params.hours.saturday }}</span>
        </div>
      
        <div class="flex justify-between py-2 px-4 bg-gray-50 rounded">
          <span class="font-medium text-gray-700">Sunday</span>
          <span class="text-gray-600">{{ .Params.hours.sunday }}</span>
        </div>
      
    </div>
  </div>
</section>
{{ end }}
           <!-- Additional Content -->
            
        {{ if .Content }}
        <section class="py-4 border-t botder-b border-gray-200">
          <h2 class="text-2xl font-light text-gray-800">About The Farm</h2>
          <div class="prose prose-xl prose-gray max-w-none">
            {{ .Content }}
          </div>
        </section>
      {{ end }}
          
        

        

        <!-- Amenities -->
        {{ if .Params.amenities }}
          <section class="space-y-4 border-t border-gray-200 py-4">
            <h2 class="text-2xl font-light text-gray-800">Amenities</h2>
            <div class="flex flex-wrap gap-2">
              {{ range .Params.amenities }}
                <span class="inline-block px-4 py-2 text-sm bg-blue-50 text-blue-700 rounded-full border border-blue-200">{{ . }}</span>
              {{ end }}
            </div>
          </section>
        {{ end }}

        <!-- Varieties -->
        {{ if .Params.varieties }}
          <section class="space-y-4 border-t border-gray-200 py-4">
            <h2 class="text-2xl font-light text-gray-800">Varieties</h2>
            <div class="flex flex-wrap gap-2">
              {{ range .Params.varieties }}
                <span class="inline-block px-4 py-2 text-sm bg-green-50 rounded-full border border-green-200">{{ . }}</span>
              {{ end }}
            </div>
          </section>
        {{ end }}

        <!-- Social Media -->
        {{ if or .Params.social.facebook .Params.social.instagram .Params.social.twitter }}
          <section class="space-y-4 border-t border-gray-200 py-4">
            <h2 class="text-2xl font-light text-gray-800">Connect on Social Media</h2>
            <div class="flex items-center space-x-6">
              {{ if .Params.social.facebook }}
                <a href="{{ .Params.social.facebook }}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 text-gray-600 hover:text-blue-600 transition-colors">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                  <span>Facebook</span>
                </a>
              {{ end }}
              {{ if .Params.social.instagram }}
                <a href="{{ .Params.social.instagram }}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 text-gray-600 hover:text-pink-600 transition-colors">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 6.62 5.367 11.987 11.988 11.987 6.62 0 11.987-5.367 11.987-11.987C24.014 5.367 18.637.001 12.017.001zM8.449 16.988c-1.297 0-2.448-.49-3.323-1.297C4.198 14.895 3.708 13.744 3.708 12.447s.49-2.448 1.418-3.323c.875-.875 2.026-1.297 3.323-1.297s2.448.422 3.323 1.297c.928.875 1.418 2.026 1.418 3.323s-.49 2.448-1.418 3.244c-.875.807-2.026 1.297-3.323 1.297zm7.83-9.404h-1.297V6.287h1.297v1.297zm-1.297 2.594c-.875-.875-2.026-1.297-3.323-1.297s-2.448.422-3.323 1.297c-.928.875-1.418 2.026-1.418 3.323s.49 2.448 1.418 3.244c.875.807 2.026 1.297 3.323 1.297s2.448-.49 3.323-1.297c.928-.796 1.418-1.947 1.418-3.244s-.49-2.448-1.418-3.323z"/></svg>
                  <span>Instagram</span>
                </a>
              {{ end }}
              {{ if .Params.social.twitter }}
                <a href="{{ .Params.social.twitter }}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 text-gray-600 hover:text-blue-400 transition-colors">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                  <span>Twitter</span>
                </a>
              {{ end }}
            </div>
          </section>
        {{ end }}

        
        
          
        

        <!-- Nearby Farms Recommendations -->
        {{ if and .Params.coordinates.latitude .Params.coordinates.longitude }}
          <section class="pt-12 border-t border-gray-200">
            <h2 class="text-2xl font-light text-gray-800 mb-6">Other Farms Nearby</h2>
            
            {{ $currentLat := .Params.coordinates.latitude }}
            {{ $currentLng := .Params.coordinates.longitude }}
            {{ $currentSlug := .Slug }}
            {{ $nearbyFarms := slice }}
            
            {{ range where site.RegularPages "Section" "farms" }}
              {{ if and (ne .Slug $currentSlug) .Params.coordinates.latitude .Params.coordinates.longitude }}
                {{ $farmLat := .Params.coordinates.latitude }}
                {{ $farmLng := .Params.coordinates.longitude }}
                
                <!-- Haversine formula for distance calculation -->
                {{ $dLat := math.Abs (sub $farmLat $currentLat) }}
                {{ $dLng := math.Abs (sub $farmLng $currentLng) }}
                {{ $a := add (math.Pow (math.Sin (div (mul $dLat 0.017453292519943295) 2)) 2) (mul (math.Cos (mul $currentLat 0.017453292519943295)) (math.Cos (mul $farmLat 0.017453292519943295)) (math.Pow (math.Sin (div (mul $dLng 0.017453292519943295) 2)) 2)) }}
                {{ $c := mul 2 (math.Atan2 (math.Sqrt $a) (math.Sqrt (sub 1 $a))) }}
                {{ $distance := mul 6371 $c }}
                
                {{ $nearbyFarms = $nearbyFarms | append (dict "farm" . "distance" $distance) }}
              {{ end }}
            {{ end }}
            
            <!-- Sort by distance and take first 3 -->
            {{ $sortedFarms := sort $nearbyFarms "distance" }}
            {{ $topThree := first 3 $sortedFarms }}
            
            {{ if $topThree }}
              <div class="grid grid-cols-1 gap-2">
                {{ range $topThree }}
                  {{ $farm := .farm }}
                  {{ $dist := .distance }}
                  <div class="bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-gray-200 px-4 py-4 transition-all duration-200 overflow-hidden">
                    <!-- Card Header -->
                    <div class="py-2">
                      <h3 class="text-lg font-semibold text-gray-900 mb-3 leading-tight">
                        <a href="{{ $farm.RelPermalink }}" class="hover:text-blue-600 transition-colors">{{ $farm.Title }}</a>
                      </h3>
                      
                      <!-- Location & Distance Info -->
                      <div class="space-y-2 mb-2">
                        {{ if $farm.Params.address.city }}
                          <div class="text-sm text-gray-600">
                            {{ $farm.Params.address.city }}, {{ $farm.Params.address.province }}
                          </div>
                        {{ end }}
                        
                        <div class="text-sm text-blue-600 font-medium">
                          {{ printf "%.1f km away" $dist }}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Card Footer -->
                    <div class="">
                      <a href="{{ $farm.RelPermalink }}" class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">
                        View Details
                      </a>
                    </div>
                  </div>
                {{ end }}
              </div>
            {{ else }}
              <p class="text-gray-600">No other farms found in the area.</p>
            {{ end }}
          </section>
        {{ end }}

        <meta itemprop="url" content="{{ .Permalink }}">
      {{ else }}
        <div class="prose prose-xl prose-gray max-w-none">
          {{ .Content }}
        </div>
        {{ partial "terms.html" (dict "taxonomy" "tags" "page" .) }}
      {{ end }}
    </article>
  </div>
{{ end }}
