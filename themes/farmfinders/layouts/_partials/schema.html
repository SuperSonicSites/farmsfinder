{{/* LocalBusiness PRIMARY. Farm signaled via additionalType. Event nested via subjectOf. */}}
{{ if and .Params.title (or .Params.categories .Params.type) }}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [

    {{/* 1) WebPage node helps indicate the primary entity of the page */}}
    {
      "@type": "WebPage",
      "@id": "{{ .Permalink }}",
      "url": "{{ .Permalink }}",
      "name": "{{ .Title }}",
      "mainEntity": { "@id": "{{ .Permalink }}#business" }
    },

    {{/* 2) PRIMARY: Business node */}}
    {
      "@type": [
        "LocalBusiness"
        {{- if or (in .Params.categories "christmas-tree") (in .Params.categories "pumpkin") (in .Params.categories "sunflower") (in .Params.categories "petting-zoo") }}, "TouristAttraction"{{- end -}}
        {{- if in .Params.categories "christmas-tree" }}, "Store"{{- end -}}
      ],
      "@id": "{{ .Permalink }}#business",
      "name": "{{ .Title }}",
      "url": "{{ .Permalink }}",
      "mainEntityOfPage": { "@id": "{{ .Permalink }}" },
      {{ with .Content }}"description": {{ . | plainify | truncate 160 | jsonify }},{{ end }}

      {{/* Images (front matter list or first 3 page images) */}}
      {{- $images := slice -}}
      {{- with .Params.images -}} {{- $images = . -}}
      {{- else -}}
        {{- with .Resources.ByType "image" -}}
          {{- range first 3 . -}}{{- $images = $images | append .Permalink -}}{{- end -}}
        {{- end -}}
      {{- end -}}
      {{- if gt (len $images) 0 -}}
      "image": {{ $images | jsonify }},
      {{- end }}

      {{ with .Params.phone }}"telephone": "{{ . }}",{{ end }}
      {{ with .Params.email }}"email": "{{ . }}",{{ end }}

      {{/* sameAs MUST be an array (no surrounding quotes) */}}
      {{- $sameAs := slice -}}
      {{- with .Params.website -}}{{ $sameAs = $sameAs | append . }}{{- end -}}
      {{- with .Params.social.facebook -}}{{ $sameAs = $sameAs | append . }}{{- end -}}
      {{- with .Params.social.instagram -}}{{ $sameAs = $sameAs | append . }}{{- end -}}
      {{- if gt (len $sameAs) 0 -}}
      "sameAs": {{ $sameAs | jsonify }},
      {{- end }}

      {{ if .Params.address }}
      "address": {
        "@type": "PostalAddress"{{ with .Params.address.street }},
        "streetAddress": "{{ . }}"{{ end }}{{ with .Params.address.city }},
        "addressLocality": "{{ . }}"{{ end }}{{ with .Params.address.province }},
        "addressRegion": "{{ . }}"{{ end }}{{ with .Params.address.postal_code }},
        "postalCode": "{{ . }}"{{ end }},
        "addressCountry": "CA"
      },
      {{ end }}

      {{ if and .Params.coordinates.latitude .Params.coordinates.longitude }}
      "geo": { "@type": "GeoCoordinates", "latitude": {{ .Params.coordinates.latitude }}, "longitude": {{ .Params.coordinates.longitude }} },
      {{ end }}

      {{- if .Params.place_id -}}
      "hasMap": "https://www.google.com/maps/place/?q=place_id:{{ .Params.place_id }}",
      "identifier": "{{ .Params.place_id }}",
      {{- else if .Params.location_link -}}
      "hasMap": "{{ .Params.location_link }}",
      {{- end }}

      {{ with .Params.price_range }}"priceRange": "{{ . }}",{{ end }}
      {{ with .Params.established }}"foundingDate": "{{ . }}",{{ end }}
      {{ with .Params.payment_methods }}"paymentAccepted": {{ . | jsonify }},{{ end }}

      {{/* Always Farm; add nuance by category */}}
      "additionalType": [
        "https://schema.org/Farm"
        {{ if .Params.categories }},
        {{- range $i, $cat := .Params.categories -}}{{ if gt $i 0 }},{{ end -}}
          {{- if eq $cat "christmas-tree" -}}"https://schema.org/GardenStore"
          {{- else if eq $cat "pumpkin" -}}"https://schema.org/TouristAttraction"
          {{- else if eq $cat "winery" -}}"https://schema.org/Winery"
          {{- else if eq $cat "brewery" -}}"https://schema.org/Brewery"
          {{- else if eq $cat "petting-zoo" -}}"https://schema.org/Zoo"
          {{- else if eq $cat "flower" -}}"https://schema.org/Florist"
          {{- else if eq $cat "meat" -}}"https://schema.org/ButcherShop"
          {{- else -}}"https://schema.org/Farm"{{- end -}}
        {{- end -}}
        {{ end }}
      ],

      {{ if .Params.categories }}"knowsAbout": {{ .Params.categories | jsonify }},{{ end }}
      {{ with .Params.type }}"slogan": "{{ . }}",{{ end }}

      {{ with .Params.amenities }}
      "amenityFeature": [
        {{- range $i, $amenity := . -}}{{ if gt $i 0 }},{{ end -}}
        { "@type": "LocationFeatureSpecification", "name": "{{ $amenity }}", "value": true }
        {{- end -}}
      ],
      {{ end }}

      {{ with .Params.varieties }}
      "makesOffer": [
        {{- range $i, $variety := . -}}{{ if gt $i 0 }},{{ end -}}
        { "@type": "Offer", "itemOffered": { "@type": "Product", "name": "{{ $variety }}" } }
        {{- end -}}
      ],
      {{ end }}

      {{/* Opening Hours (AM/PM → 24h) with seasonal validFrom/validThrough */}}
      {{ if .Params.hours }}
      {{- $daysMap := dict "monday" "Monday" "tuesday" "Tuesday" "wednesday" "Wednesday" "thursday" "Thursday" "friday" "Friday" "saturday" "Saturday" "sunday" "Sunday" -}}
      {{- $defaultOpen := (cond (in .Params.categories "christmas-tree") "2025-11-15" (cond (in .Params.categories "pumpkin") "2025-09-01" (cond (in .Params.categories "sunflower") "2025-07-01" "2025-01-01"))) -}}
      {{- $defaultClose := (cond (in .Params.categories "christmas-tree") "2025-12-24" (cond (in .Params.categories "pumpkin") "2025-10-31" (cond (in .Params.categories "sunflower") "2025-08-31" "2025-12-31"))) -}}
      {{- $validFrom := .Params.opening_date | default $defaultOpen -}}
      {{- $validThrough := .Params.closing_date | default $defaultClose -}}
      "openingHoursSpecification": [
        {{- $comma := false -}}
        {{- range $day, $hours := .Params.hours -}}
          {{- $dayName := index $daysMap $day -}}
          {{- if and $hours (ne $hours "Closed") (ne $hours "By appointment") -}}
            {{- if $comma }},{{ end -}}{{- $comma = true -}}
            {{- $h := $hours | replaceRE "Dark" "20:00" | replaceRE "untill" "to" | replaceRE "Noon" "12:00" -}}
            {{- $open := (index (split $h " to ") 0) | strings.TrimSpace -}}
            {{- $close := (index (split $h " to ") 1) | strings.TrimSpace -}}

            {{/* OPEN → 24h */}}
            {{- if in $open "PM" -}}
              {{- $openClean := $open | replaceRE "PM" "" | strings.TrimSpace -}}
              {{- if in $openClean ":" -}}
                {{- $parts := split $openClean ":" -}}
                {{- $hour := (index $parts 0) | int -}}{{- if ne $hour 12 }}{{ $hour = add $hour 12 }}{{ end -}}
                {{- $open = printf "%02d:%s" $hour (index $parts 1) -}}
              {{- else -}}
                {{- $hour := $openClean | int -}}{{- if ne $hour 12 }}{{ $hour = add $hour 12 }}{{ end -}}
                {{- $open = printf "%02d:00" $hour -}}
              {{- end -}}
            {{- else if in $open "AM" -}}
              {{- $openClean := $open | replaceRE "AM" "" | strings.TrimSpace -}}
              {{- if in $openClean ":" -}}
                {{- $parts := split $openClean ":" -}}
                {{- $hour := (index $parts 0) | int -}}{{- if eq $hour 12 }}{{ $hour = 0 }}{{ end -}}
                {{- $open = printf "%02d:%s" $hour (index $parts 1) -}}
              {{- else -}}
                {{- $hour := $openClean | int -}}{{- if eq $hour 12 }}{{ $hour = 0 }}{{ end -}}
                {{- $open = printf "%02d:00" $hour -}}
              {{- end -}}
            {{- else if not (in $open ":") -}}
              {{- $open = printf "%s:00" $open -}}
            {{- end -}}

            {{/* CLOSE → 24h */}}
            {{- if in $close "PM" -}}
              {{- $closeClean := $close | replaceRE "PM" "" | strings.TrimSpace -}}
              {{- if in $closeClean ":" -}}
                {{- $parts := split $closeClean ":" -}}
                {{- $hour := (index $parts 0) | int -}}{{- if ne $hour 12 }}{{ $hour = add $hour 12 }}{{ end -}}
                {{- $close = printf "%02d:%s" $hour (index $parts 1) -}}
              {{- else -}}
                {{- $hour := $closeClean | int -}}{{- if ne $hour 12 }}{{ $hour = add $hour 12 }}{{ end -}}
                {{- $close = printf "%02d:00" $hour -}}
              {{- end -}}
            {{- else if in $close "AM" -}}
              {{- $closeClean := $close | replaceRE "AM" "" | strings.TrimSpace -}}
              {{- if in $closeClean ":" -}}
                {{- $parts := split $closeClean ":" -}}
                {{- $hour := (index $parts 0) | int -}}{{- if eq $hour 12 }}{{ $hour = 0 }}{{ end -}}
                {{- $close = printf "%02d:%s" $hour (index $parts 1) -}}
              {{- else -}}
                {{- $hour := $closeClean | int -}}{{- if eq $hour 12 }}{{ $hour = 0 }}{{ end -}}
                {{- $close = printf "%02d:00" $hour -}}
              {{- end -}}
            {{- else if not (in $close ":") -}}
              {{- $close = printf "%s:00" $close -}}
            {{- end -}}

        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": "https://schema.org/{{ $dayName }}",
          "opens": "{{ $open }}",
          "closes": "{{ $close }}",
          "validFrom": "{{ $validFrom }}",
          "validThrough": "{{ $validThrough }}"
        }
          {{- end -}}
        {{- end -}}
      ],
      {{ end }}

      "publicAccess": true,
      "isAccessibleForFree": {{ if or (in .Params.amenities "Free Admission") (eq .Params.price_range "Free") }}true{{ else }}false{{ end }},
      {{ with .Params.zoho_id }}"alternateName": "{{ . }}",{{ end }}
      {{ with .Params.pet_friendly }}"petsAllowed": {{ . }},{{ end }}

      {{/* SECONDARY: seasonal Event nested so Business stays primary */}}
      {{- $showEvent := or .Params.opening_date (in .Params.categories "christmas-tree") (in .Params.categories "pumpkin") (in .Params.categories "sunflower") -}}
      {{- if $showEvent -}}
      "subjectOf": {
        "@type": "Event",
        "@id": "{{ .Permalink }}#season-{{ now.Format "2006" }}",
        "name": "{{ .Title }} {{ now.Format "2006" }} Season",
        "description": "Visit {{ .Title }} for {{ with .Params.categories }}{{ delimit . ", " " and " | replaceRE "-" " " }}{{ else }}seasonal{{ end }} experiences",
        {{- $eventStart := .Params.opening_date | default (cond (in .Params.categories "christmas-tree") "2025-11-15" (cond (in .Params.categories "pumpkin") "2025-09-01" (cond (in .Params.categories "sunflower") "2025-07-01" "2025-06-01"))) -}}
        {{- $eventEnd := .Params.closing_date | default (cond (in .Params.categories "christmas-tree") "2025-12-24" (cond (in .Params.categories "pumpkin") "2025-10-31" (cond (in .Params.categories "sunflower") "2025-08-31" "2025-12-31"))) -}}
        "startDate": "{{ $eventStart }}",
        "endDate": "{{ $eventEnd }}",
        "url": "{{ .Params.website | default .Permalink }}",
        {{- if gt (len $images) 0 -}}"image": {{ $images | jsonify }},{{ end }}
        "location": { "@id": "{{ .Permalink }}#business" },
        "organizer": { "@id": "{{ .Permalink }}#business" },
        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
        "eventStatus": "https://schema.org/EventScheduled",
        {{- $nums := findRE `[0-9]+(?:\.[0-9]+)?` (.Params.price_range | default "") -}}
        "isAccessibleForFree": {{ if or (in .Params.amenities "Free Admission") (eq .Params.price_range "Free") }}true{{ else }}false{{ end }}
        {{- if ge (len $nums) 1 -}},
        "offers": {
          "@type": "AggregateOffer",
          "lowPrice": {{ index $nums 0 }},
          "highPrice": {{ if ge (len $nums) 2 }}{{ index $nums 1 }}{{ else }}{{ index $nums 0 }}{{ end }},
          "priceCurrency": "CAD",
          "availability": "https://schema.org/InStock",
          "url": "{{ .Params.website | default .Permalink }}",
          "validFrom": "{{ .Params.opening_date | default (cond (in .Params.categories "christmas-tree") "2025-09-01" (cond (in .Params.categories "pumpkin") "2025-08-15" (cond (in .Params.categories "sunflower") "2025-06-15" "2025-06-01"))) }}"
        }
        {{- end }}
      },
      {{- end }}

      {{/* Keep a final property with no trailing comma to avoid JSON errors */}}
      "potentialAction": {
        "@type": "ReserveAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "{{ .Params.website | default .Params.location_link }}",
          "actionPlatform": ["https://schema.org/DesktopWebPlatform", "https://schema.org/MobileWebPlatform"]
        },
        "result": { "@type": "Reservation", "name": "Farm Visit" }
      }
    }

  ]
}
</script>
{{ end }}
